# フィボナッチ + MA + ナンピン EA アルゴリズム仕様書

## 概要

このEAは以下の戦略に基づいてトレードを行います：
- フィボナッチリトレースメントとMAが重なるポイントでエントリー
- 逆行時はナンピン（1:3:3:5の比率）
- 平均建値からTP/SLで決済

---

## 現在の実装（⚠️ 要確認）

### 1. フィボナッチレベルの計算方法

```
過去50本のバー（4時間足）から：
1. 最高値（High）と最安値（Low）を特定
2. 最高値の位置と最安値の位置を比較してトレンド方向を判定
3. フィボナッチレベルを計算
```

#### トレンド判定ロジック

```
if (最高値のインデックス < 最安値のインデックス):
    # 最高値が最近 → 上昇トレンドと判定
    trend = 1 (BUY方向)
    fibo_38.2% = 最高値 - (最高値-最安値) × 0.382
    fibo_61.8% = 最高値 - (最高値-最安値) × 0.618
else:
    # 最安値が最近 → 下降トレンドと判定
    trend = -1 (SELL方向)
    fibo_38.2% = 最安値 + (最高値-最安値) × 0.382
    fibo_61.8% = 最安値 + (最高値-最安値) × 0.618
```

#### ⚠️ 問題点

現在のロジックでは**インデックスの小さい方が「最近」**と判定しています。
これは **ArraySetAsSeries(true)** を使用しているため、インデックス0が最新バーになります。

つまり：
- `highest_idx < lowest_idx` → 最高値の方が最新に近い → **下落中**（高値をつけてから下落）
- `highest_idx > lowest_idx` → 最安値の方が最新に近い → **上昇中**（安値をつけてから上昇）

**現在の実装はこれが逆になっている可能性があります！**

---

### 2. エントリー条件

現在の実装：

```
エントリー条件 =
    (価格がフィボナッチレベル付近) AND (価格がMA付近) AND (トレンドフィルター)
```

具体的には：

```python
# フィボナッチ条件
fibo_condition = |現在価格 - fibo_38.2%| < 許容誤差(30pips)
              OR |現在価格 - fibo_61.8%| < 許容誤差(30pips)

# MA条件
ma_condition = |現在価格 - MA20| < 許容誤差(30pips)
            OR |現在価格 - MA50| < 許容誤差(30pips)
            OR |現在価格 - MA100| < 許容誤差(30pips)

# トレンドフィルター
trend_filter = (上昇トレンド AND 価格 > MA200)
            OR (下降トレンド AND 価格 < MA200)

# 最終エントリー条件
entry = fibo_condition AND ma_condition AND trend_filter
```

#### ⚠️ 本来の意図との違い

**元の要望（推測）：**
> フィボナッチラインとMAラインが重なる（近い）ポイントで価格がタッチしたらエントリー

**現在の実装：**
> 価格がフィボナッチレベル付近 AND 価格がMA付近 → 結果的にフィボとMAが近いことを意味するが、直接比較はしていない

---

### 3. エントリー方向の決定

```
if trend == 1:  # 上昇トレンドと判定
    → BUY（押し目買い）

if trend == -1:  # 下降トレンドと判定
    → SELL（戻り売り）
```

---

### 4. ナンピンロジック

```
ナンピン条件：
  - 現在ポジションあり
  - ナンピン回数 < 最大回数(3)
  - 直前のエントリー価格から逆行 >= ナンピン間隔(20-30pips)

ナンピン実行：
  - BUYポジション中に価格が下落 → 追加BUY
  - SELLポジション中に価格が上昇 → 追加SELL

ロット比率：1:3:3:5
  - 初回エントリー: 0.1ロット
  - 1回目ナンピン: 0.3ロット
  - 2回目ナンピン: 0.3ロット
  - 3回目ナンピン: 0.5ロット
```

---

### 5. 決済ロジック

```
平均建値 = Σ(エントリー価格 × ロット) / Σ(ロット)

BUYの場合:
  TP = 平均建値 + TP_pips
  SL = 平均建値 - SL_pips

SELLの場合:
  TP = 平均建値 - TP_pips
  SL = 平均建値 + SL_pips
```

---

## 図解：現在のアルゴリズム

```
                    最高値 ─────────────────────── 100%
                      │
                      │    ← 上昇トレンド時のエントリーゾーン
                      │
              fibo_38.2% ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─  38.2%
                      │
                      │    ← MAと重なればエントリー
                      │
              fibo_61.8% ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─  61.8%
                      │
                      │
                    最安値 ─────────────────────── 0%


【エントリー判定フロー】

    ┌─────────────────────────────────────────┐
    │  過去50本から最高値・最安値を検出        │
    └─────────────────────────────────────────┘
                      │
                      ▼
    ┌─────────────────────────────────────────┐
    │  トレンド方向を判定                      │
    │  (最高値と最安値どちらが最近か)          │
    └─────────────────────────────────────────┘
                      │
                      ▼
    ┌─────────────────────────────────────────┐
    │  フィボナッチ38.2%と61.8%を計算         │
    └─────────────────────────────────────────┘
                      │
                      ▼
    ┌─────────────────────────────────────────┐
    │  価格がフィボレベル ± 30pips以内？       │
    └─────────────────────────────────────────┘
          │NO                    │YES
          ▼                      ▼
       スキップ      ┌─────────────────────────┐
                    │  価格がMA ± 30pips以内？  │
                    └─────────────────────────┘
                          │NO          │YES
                          ▼            ▼
                       スキップ    ┌─────────────┐
                                  │  MA200で     │
                                  │  トレンド確認│
                                  └─────────────┘
                                        │
                                        ▼
                                  ┌─────────────┐
                                  │  エントリー  │
                                  └─────────────┘
```

---

## 想定される問題点

### 1. トレンド判定の方向が逆？

```python
# 現在のコード
if highest_idx < lowest_idx:
    trend = 1  # 上昇？
```

`ArraySetAsSeries(true)` を使用しているため：
- インデックス0 = 最新バー
- インデックス49 = 最古バー

したがって `highest_idx < lowest_idx` は「高値の方が最近」を意味し、
これは**下落トレンド**（高値から下落中）と解釈すべきでは？

### 2. 「フィボとMAが重なる」の解釈

**現在の実装：**
- 価格がフィボ付近 AND 価格がMA付近
- → 間接的にフィボとMAが近いことを確認

**別の解釈（本来の意図？）：**
- フィボレベルとMAの値が直接近い（重なっている）
- → そのレベルで価格がタッチしたらエントリー

```python
# 別の解釈の実装例
overlap_condition = |fibo_38.2% - MA20| < 許容誤差
                 OR |fibo_38.2% - MA50| < 許容誤差
                 ...

entry_condition = overlap_condition AND (価格がそのレベルにタッチ)
```

---

## 確認が必要な点

1. **トレンド判定の方向は正しいですか？**
   - 現在：高値が最近 → 上昇トレンド → BUY
   - 本来：高値が最近 → 下落トレンド → SELL？

2. **エントリー条件の解釈は正しいですか？**
   - 現在：価格がフィボ付近 AND 価格がMA付近
   - 本来：フィボレベルとMAが重なるポイントで価格タッチ？

3. **フィボナッチの基準となる高値・安値の決め方は？**
   - 現在：過去50本の単純な最高値・最安値
   - 本来：スイングハイ・スイングローを使用？

---

## パラメータ一覧

| パラメータ | 現在の値 | 説明 |
|-----------|---------|------|
| TimeFrame | H4 | 4時間足 |
| FiboLookbackBars | 50 | フィボ計算用の過去バー数 |
| OverlapTolerance_Pips | 30-35 | Fibo/MA許容誤差 |
| MA_Period1 | 20 | MA期間1 |
| MA_Period2 | 50 | MA期間2 |
| MA_Period3 | 100 | MA期間3 |
| TrendMA_Period | 200 | トレンドフィルター用MA |
| TakeProfit_Pips | 70-100 | 利確pips |
| StopLoss_Pips | 80-100 | 損切pips |
| NanpinInterval_Pips | 20-30 | ナンピン間隔 |
| MaxNanpinCount | 3 | 最大ナンピン回数 |
| Lot比率 | 1:3:3:5 | ナンピンロット比率 |
