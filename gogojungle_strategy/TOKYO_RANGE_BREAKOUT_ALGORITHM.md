# Tokyo Range Breakout 戦略 - アルゴリズム仕様書

## 概要

東京時間（9:00-15:00 JST）に形成される価格レンジを基準に、ロンドン時間（15:00-23:00 JST）のブレイクアウトでエントリーする日中ブレイクアウト戦略。

---

## バックテスト結果サマリー (USDJPY, 2015-2025)

| 指標 | 値 |
|------|------|
| トレード数 | 714 |
| 勝率 | 96.2% |
| プロフィットファクター | 4.91 |
| 合計獲得pips | +5,305.8 |
| 最大ドローダウン | -90.9 pips |
| 最大連勝 | 56 |
| 最大連敗 | 1 |
| リカバリーファクター | 58.4 |
| TP / SL | 10 pips / 50 pips |

---

## アルゴリズム詳細

### ステップ1: 東京レンジの定義

```
東京時間 = 0:00 - 6:00 UTC (= 9:00 - 15:00 JST)

Tokyo_High = 東京時間内のM5バーの最高値 (High の最大値)
Tokyo_Low  = 東京時間内のM5バーの最安値 (Low の最小値)
Tokyo_Range = Tokyo_High - Tokyo_Low
```

**レンジフィルター条件:**
```
10 pips <= Tokyo_Range <= 50 pips

(USDJPY: 0.10円 <= レンジ幅 <= 0.50円)
```

- レンジが小さすぎる場合 (<10 pips): ノイズによるダマシが多い
- レンジが大きすぎる場合 (>50 pips): 既にトレンドが発生している可能性

東京時間のM5バー数が10本未満の日はスキップ。

### ステップ2: ブレイクアウト判定

```
ロンドン時間 = 6:00 - 14:00 UTC (= 15:00 - 23:00 JST)

ブレイクアウトバッファ = 5 pips (= 0.05円)
```

**ロンドン時間中の各M5バーの終値(Close)でチェック:**

```
上方ブレイクアウト:
  Close > Tokyo_High + Buffer  →  BUYエントリー

下方ブレイクアウト:
  Close < Tokyo_Low - Buffer   →  SELLエントリー
```

- 1日1トレードのみ（ブレイクアウトが発生したら当日はそれ以上エントリーしない）
- ブレイクアウトバッファは、ダマシのブレイクアウトを防ぐためのフィルター

### ステップ3: エントリー

```
エントリー価格 = ブレイクアウト時のClose価格

BUYの場合:
  Entry = Close
  TP = Entry + 10 pips (= +0.10円)
  SL = Entry - 50 pips (= -0.50円)

SELLの場合:
  Entry = Close
  TP = Entry - 10 pips (= -0.10円)
  SL = Entry + 50 pips (= +0.50円)
```

### ステップ4: 決済

**ロンドン時間の残り（エントリー後〜14:00 UTC）で決済判定:**

```
BUYの場合:
  M5バーのHigh >= Entry + TP距離  →  利確 (WIN)
  M5バーのLow  <= Entry - SL距離  →  損切り (LOSS)

SELLの場合:
  M5バーのLow  <= Entry - TP距離  →  利確 (WIN)
  M5バーのHigh >= Entry + SL距離  →  損切り (LOSS)
```

- 同一バー内でTPとSLの両方にヒットする場合、TPを優先して判定
- ロンドン時間内に決済されない場合はトレードなし扱い（ノーカウント）

### ステップ5: スプレッドコスト

```
スプレッド = 0.3 pips (= 0.003円)

利確時の実質獲得pips = TP - スプレッド = 10 - 0.3 = 9.7 pips
損切時の実質損失pips = -(SL + スプレッド) = -(50 + 0.3) = -50.3 pips
```

---

## パラメータ一覧

| パラメータ | デフォルト値 | 説明 |
|-----------|------------|------|
| `tokyo_start_hour` | 0 (UTC) | 東京レンジ収集開始時間 |
| `tokyo_end_hour` | 6 (UTC) | 東京レンジ収集終了時間 |
| `london_start_hour` | 6 (UTC) | ブレイクアウト判定開始時間 |
| `london_end_hour` | 14 (UTC) | ブレイクアウト判定終了時間 |
| `min_range_pips` | 10 | 最小レンジ幅 (pips) |
| `max_range_pips` | 50 | 最大レンジ幅 (pips) |
| `buffer_pips` | 5 | ブレイクアウトバッファ (pips) |
| `tp_pips` | 10 | 利確幅 (pips) |
| `sl_pips` | 50 | 損切り幅 (pips) |
| `spread_pips` | 0.3 | 想定スプレッド (pips) |

---

## 戦略の特性

### 高勝率の理由

1. **非対称TP/SL比率 (1:5)**: TPが小さいため利確しやすい
2. **レンジフィルター**: 適切なボラティリティの日のみトレード
3. **バッファ**: ダマシのブレイクアウトを排除
4. **1日1トレード**: 過剰取引を防止

### リスク

1. **ペイオフレシオが低い** (1:5): 1回の負けで約5回分の利益を失う
2. **トレンド相場でSLヒット**: 強いレンジブレイク後に逆行した場合に大きな損失
3. **勝率が低下すると急激に損益が悪化**: 勝率90%以下ではマイナスになる可能性

### 損益分岐勝率

```
TP = 9.7 pips (スプレッド控除後)
SL = 50.3 pips (スプレッド加算後)

損益分岐勝率 = SL / (TP + SL) = 50.3 / (9.7 + 50.3) = 83.8%
```

現在の勝率96.2%は損益分岐点83.8%を大幅に上回っている。

---

## データ要件

- **通貨ペア**: USDJPY (他通貨ペア検証中)
- **時間足**: M5 (5分足) ※M1データからリサンプリング
- **データ期間**: 2015年 - 2025年 (10年)
- **データソース**: Axiory MT4 Standard ヒストリカルデータ
- **データ形式**: CSV (date, time, open, high, low, close, volume)

---

## フローチャート

```
日次ループ開始
    │
    ├── 東京時間 (0-6 UTC) のデータ取得
    │   └── M5バー数 < 10 → スキップ
    │
    ├── Tokyo_High, Tokyo_Low を計算
    │   └── レンジ幅チェック
    │       ├── < 10 pips → スキップ
    │       └── > 50 pips → スキップ
    │
    ├── ロンドン時間 (6-14 UTC) のバーを順番にチェック
    │   ├── Close > Tokyo_High + 5pips → BUYエントリー
    │   ├── Close < Tokyo_Low  - 5pips → SELLエントリー
    │   └── それ以外 → 次のバーへ
    │
    ├── エントリー後の残りバーで決済チェック
    │   ├── TP到達 → WIN (+9.7 pips)
    │   ├── SL到達 → LOSS (-50.3 pips)
    │   └── 時間切れ → ノーカウント
    │
    └── 次の日へ
```

---

## 検証方法

1. `tokyo_range_breakout_standalone.py` を使用
2. AxioryからM1データをダウンロード
3. スクリプトを実行すると結果が出力される

```bash
pip install pandas numpy matplotlib
python tokyo_range_breakout_standalone.py
```
